<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 11.0.0"/>
    <title>simmate.file_converters.structure.cif API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(:first-of-type){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.pdoc details{filter:opacity(1);}.pdoc details:not([open]){height:0;}.pdoc details > summary{position:absolute;top:-35px;right:0;font-size:.75rem;color:var(--muted);padding:0 .7em;user-select:none;cursor:pointer;}.pdoc details > summary:focus{outline:0;}.pdoc > section:first-of-type details > summary{top:-20px;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc .headerlink{position:absolute;width:0;margin-left:-1.5rem;line-height:1.4rem;font-size:1.5rem;font-weight:normal;transition:all 100ms ease-in-out;opacity:0;user-select:none;}.pdoc .attr > .headerlink{margin-left:-2.5rem;}.pdoc *:hover > .headerlink,.pdoc *:target > .attr > .headerlink{opacity:1;}.pdoc .attr{display:block;color:var(--text);margin:.5rem 0 .5rem;padding:.4rem 5rem .4rem 1rem;background-color:var(--accent);}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{white-space:pre-wrap;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../structure.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;simmate.file_converters.structure</a>

<a href="https://github.com/jacksund/simmate">            <img src="https://github.com/jacksund/simmate/blob/main/src/simmate/website/static_files/images/simmate-logo.svg?raw=true" class="logo" alt="project logo"/>
</a>
            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



        <h2>API Documentation</h2>
            <ul class="memberlist">
            <li>
                    <a class="class" href="#CifParser">CifParser</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#CifParser.__init__">CifParser</a>
                        </li>
                        <li>
                                <a class="function" href="#CifParser.from_string">from_string</a>
                        </li>
                        <li>
                                <a class="function" href="#CifParser.get_lattice">get_lattice</a>
                        </li>
                        <li>
                                <a class="function" href="#CifParser.get_symops">get_symops</a>
                        </li>
                        <li>
                                <a class="function" href="#CifParser.get_magsymops">get_magsymops</a>
                        </li>
                        <li>
                                <a class="function" href="#CifParser.parse_oxi_states">parse_oxi_states</a>
                        </li>
                        <li>
                                <a class="function" href="#CifParser.parse_magmoms">parse_magmoms</a>
                        </li>
                        <li>
                                <a class="function" href="#CifParser.get_structures">get_structures</a>
                        </li>
                        <li>
                                <a class="function" href="#CifParser.get_bibtex_string">get_bibtex_string</a>
                        </li>
                        <li>
                                <a class="function" href="#CifParser.as_dict">as_dict</a>
                        </li>
                        <li>
                                <a class="variable" href="#CifParser.has_errors">has_errors</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#CifWriter">CifWriter</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#CifWriter.__init__">CifWriter</a>
                        </li>
                        <li>
                                <a class="variable" href="#CifWriter.ciffile">ciffile</a>
                        </li>
                        <li>
                                <a class="function" href="#CifWriter.write_file">write_file</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section>
                        <a class="pdoc-button git-button" href="https://github.com/jacksund/simmate/tree/main/src/simmate/file_converters/structure/cif.py">Edit on GitHub</a>
                    <h1 class="modulename">
<a href="./../../../simmate.html">simmate</a><wbr>.<a href="./../../file_converters.html">file_converters</a><wbr>.<a href="./../structure.html">structure</a><wbr>.cif    </h1>

                        <div class="docstring"><p>This converter simply imports a pymatgen class. With this you can quickly
convert between Simmate.toolkit and CIF files.</p>

<p>This class is built-in to the base toolkit class, so you typically can read/write
with CIFs without ever loading this module directly.</p>

<p>Recommended use:</p>

<div class="pdoc-code codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn"><a href="../../toolkit.html">simmate.toolkit</a></span> <span class="kn">import</span> <span class="n">Structure</span>

<span class="c1"># read a cif file</span>
<span class="n">initial_structure</span> <span class="o">=</span> <span class="n">Structure</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="s2">&quot;example.cif&quot;</span><span class="p">)</span>

<span class="c1"># write a cif file</span>
<span class="n">initial_structure</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cif&quot;</span><span class="p">,</span> <span class="s2">&quot;my_new_file.cif&quot;</span><span class="p">)</span>
</code></pre></div>

<p>For advanced use, you can interact with this class directly:</p>

<div class="pdoc-code codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn"><a href="">simmate.file_converters.structure.cif</a></span> <span class="kn">import</span> <span class="n">CifParser</span>

<span class="c1"># load from file</span>
<span class="n">cif_data</span> <span class="o">=</span> <span class="n">CifParser</span><span class="p">(</span><span class="s2">&quot;example.cif&quot;</span><span class="p">)</span>

<span class="c1"># then access underlying data</span>
<span class="n">cif_data</span><span class="o">.</span><span class="n">get_structures</span><span class="p">()</span>
</code></pre></div>
</div>

                        <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This converter simply imports a pymatgen class. With this you can quickly</span>
<span class="sd">convert between Simmate.toolkit and CIF files.</span>

<span class="sd">This class is built-in to the base toolkit class, so you typically can read/write</span>
<span class="sd">with CIFs without ever loading this module directly.</span>

<span class="sd">Recommended use:</span>
<span class="sd">``` python</span>

<span class="sd">from simmate.toolkit import Structure</span>

<span class="sd"># read a cif file</span>
<span class="sd">initial_structure = Structure.from_file(&quot;example.cif&quot;)</span>

<span class="sd"># write a cif file</span>
<span class="sd">initial_structure.to(&quot;cif&quot;, &quot;my_new_file.cif&quot;)</span>

<span class="sd">```</span>

<span class="sd">For advanced use, you can interact with this class directly:</span>

<span class="sd">``` python</span>
<span class="sd">from simmate.file_converters.structure.cif import CifParser</span>

<span class="sd"># load from file</span>
<span class="sd">cif_data = CifParser(&quot;example.cif&quot;)</span>

<span class="sd"># then access underlying data</span>
<span class="sd">cif_data.get_structures()</span>
<span class="sd">```</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">from</span> <span class="nn">pymatgen.io.cif</span> <span class="kn">import</span> <span class="n">CifParser</span><span class="p">,</span> <span class="n">CifWriter</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;CifParser&quot;</span><span class="p">,</span> <span class="s2">&quot;CifWriter&quot;</span><span class="p">]</span>
</pre></div>

        </details>

            </section>
                <section id="CifParser">
                                <div class="attr class">
        <a class="headerlink" href="#CifParser">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">CifParser</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">CifParser</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses a CIF file. Attempts to fix CIFs that are out-of-spec, but will</span>
<span class="sd">    issue warnings if corrections applied. These are also stored in the</span>
<span class="sd">    CifParser&#39;s errors attribute.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">occupancy_tolerance</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">site_tolerance</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            filename (str): CIF filename, bzipped or gzipped CIF files are fine too.</span>
<span class="sd">            occupancy_tolerance (float): If total occupancy of a site is between 1</span>
<span class="sd">                and occupancy_tolerance, the occupancies will be scaled down to 1.</span>
<span class="sd">            site_tolerance (float): This tolerance is used to determine if two</span>
<span class="sd">                sites are sitting in the same position, in which case they will be</span>
<span class="sd">                combined to a single disordered site. Defaults to 1e-4.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_occupancy_tolerance</span> <span class="o">=</span> <span class="n">occupancy_tolerance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_site_tolerance</span> <span class="o">=</span> <span class="n">site_tolerance</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cif</span> <span class="o">=</span> <span class="n">CifFile</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cif</span> <span class="o">=</span> <span class="n">CifFile</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

        <span class="c1"># store if CIF contains features from non-core CIF dictionaries</span>
        <span class="c1"># e.g. magCIF</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_flags</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">is_magcif</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Checks to see if file appears to be a magCIF file (heuristic).</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Doesn&#39;t seem to be a canonical way to test if file is magCIF or</span>
            <span class="c1"># not, so instead check for magnetic symmetry datanames</span>
            <span class="n">prefixes</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;_space_group_magn&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_atom_site_moment&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_space_group_symop_magn&quot;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cif</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">prefixes</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                            <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">feature_flags</span><span class="p">[</span><span class="s2">&quot;magcif&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_magcif</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">is_magcif_incommensurate</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Checks to see if file contains an incommensurate magnetic</span>
<span class="sd">            structure (heuristic).</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Doesn&#39;t seem to be a canonical way to test if magCIF file</span>
            <span class="c1"># describes incommensurate structure or not, so instead check</span>
            <span class="c1"># for common datanames</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_flags</span><span class="p">[</span><span class="s2">&quot;magcif&quot;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">prefixes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;_cell_modulation_dimension&quot;</span><span class="p">,</span> <span class="s2">&quot;_cell_wave_vector&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cif</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">prefixes</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                            <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">feature_flags</span><span class="p">[</span><span class="s2">&quot;magcif_incommensurate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_magcif_incommensurate</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cif</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># pass individual CifBlocks to _sanitize_data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cif</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sanitize_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cif</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_string</span><span class="p">(</span><span class="n">cif_string</span><span class="p">,</span> <span class="n">occupancy_tolerance</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a CifParser from a string.</span>

<span class="sd">        Args:</span>
<span class="sd">            cif_string (str): String representation of a CIF.</span>
<span class="sd">            occupancy_tolerance (float): If total occupancy of a site is</span>
<span class="sd">                between 1 and occupancy_tolerance, the occupancies will be</span>
<span class="sd">                scaled down to 1.</span>

<span class="sd">        Returns:</span>
<span class="sd">            CifParser</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">cif_string</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">CifParser</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">occupancy_tolerance</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_sanitize_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Some CIF files do not conform to spec. This function corrects</span>
<span class="sd">        known issues, particular in regards to Springer materials/</span>
<span class="sd">        Pauling files.</span>

<span class="sd">        This function is here so that CifParser can assume its</span>
<span class="sd">        input conforms to spec, simplifying its implementation.</span>
<span class="sd">        :param data: CifBlock</span>
<span class="sd">        :return: data CifBlock</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This part of the code deals with handling formats of data as found in</span>
<span class="sd">        CIF files extracted from the Springer Materials/Pauling File</span>
<span class="sd">        databases, and that are different from standard ICSD formats.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># check for implicit hydrogens, warn if any present</span>
        <span class="k">if</span> <span class="s2">&quot;_atom_site_attached_hydrogens&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">attached_hydrogens</span> <span class="o">=</span> <span class="p">[</span><span class="n">str2float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_attached_hydrogens&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">str2float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attached_hydrogens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;Structure has implicit hydrogens defined, &quot;</span>
                    <span class="s2">&quot;parsed structure unlikely to be suitable for use &quot;</span>
                    <span class="s2">&quot;in calculations unless hydrogens added.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Check to see if &quot;_atom_site_type_symbol&quot; exists, as some test CIFs do</span>
        <span class="c1"># not contain this key.</span>
        <span class="k">if</span> <span class="s2">&quot;_atom_site_type_symbol&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

            <span class="c1"># Keep a track of which data row needs to be removed.</span>
            <span class="c1"># Example of a row: Nb,Zr &#39;0.8Nb + 0.2Zr&#39; .2a .m-3m 0 0 0 1 14</span>
            <span class="c1"># &#39;rhombic dodecahedron, Nb&lt;sub&gt;14&lt;/sub&gt;&#39;</span>
            <span class="c1"># Without this code, the above row in a structure would be parsed</span>
            <span class="c1"># as an ordered site with only Nb (since</span>
            <span class="c1"># CifParser would try to parse the first two characters of the</span>
            <span class="c1"># label &quot;Nb,Zr&quot;) and occupancy=1.</span>
            <span class="c1"># However, this site is meant to be a disordered site with 0.8 of</span>
            <span class="c1"># Nb and 0.2 of Zr.</span>
            <span class="n">idxs_to_remove</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">new_atom_site_label</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">new_atom_site_type_symbol</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">new_atom_site_occupancy</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">new_fract_x</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">new_fract_y</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">new_fract_z</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">el_row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_label&quot;</span><span class="p">]):</span>

                <span class="c1"># CIF files from the Springer Materials/Pauling File have</span>
                <span class="c1"># switched the label and symbol. Thus, in the</span>
                <span class="c1"># above shown example row, &#39;0.8Nb + 0.2Zr&#39; is the symbol.</span>
                <span class="c1"># Below, we split the strings on &#39; + &#39; to</span>
                <span class="c1"># check if the length (or number of elements) in the label and</span>
                <span class="c1"># symbol are equal.</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_type_symbol&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; + &quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_label&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; + &quot;</span><span class="p">)</span>
                <span class="p">):</span>

                    <span class="c1"># Dictionary to hold extracted elements and occupancies</span>
                    <span class="n">els_occu</span> <span class="o">=</span> <span class="p">{}</span>

                    <span class="c1"># parse symbol to get element names and occupancy and store</span>
                    <span class="c1"># in &quot;els_occu&quot;</span>
                    <span class="n">symbol_str</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_type_symbol&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">symbol_str_lst</span> <span class="o">=</span> <span class="n">symbol_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; + &quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">elocc_idx</span><span class="p">,</span> <span class="n">sym</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">symbol_str_lst</span><span class="p">):</span>
                        <span class="c1"># Remove any bracketed items in the string</span>
                        <span class="n">symbol_str_lst</span><span class="p">[</span><span class="n">elocc_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\([0-9]*\)&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">sym</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

                        <span class="c1"># Extract element name and its occupancy from the</span>
                        <span class="c1"># string, and store it as a</span>
                        <span class="c1"># key-value pair in &quot;els_occ&quot;.</span>
                        <span class="n">els_occu</span><span class="p">[</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\D+&quot;</span><span class="p">,</span> <span class="n">symbol_str_lst</span><span class="p">[</span><span class="n">elocc_idx</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;sup&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;0&quot;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\.?\d+&quot;</span><span class="p">,</span> <span class="n">symbol_str_lst</span><span class="p">[</span><span class="n">elocc_idx</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())[</span><span class="mi">1</span><span class="p">])</span>

                    <span class="n">x</span> <span class="o">=</span> <span class="n">str2float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_fract_x&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">])</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">str2float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_fract_y&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">])</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="n">str2float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_fract_z&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">])</span>

                    <span class="k">for</span> <span class="n">et</span><span class="p">,</span> <span class="n">occu</span> <span class="ow">in</span> <span class="n">els_occu</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="c1"># new atom site labels have &#39;fix&#39; appended</span>
                        <span class="n">new_atom_site_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">et</span> <span class="o">+</span> <span class="s2">&quot;_fix&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_atom_site_label</span><span class="p">)))</span>
                        <span class="n">new_atom_site_type_symbol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">et</span><span class="p">)</span>
                        <span class="n">new_atom_site_occupancy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">occu</span><span class="p">))</span>
                        <span class="n">new_fract_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                        <span class="n">new_fract_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
                        <span class="n">new_fract_z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>

                    <span class="n">idxs_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

            <span class="c1"># Remove the original row by iterating over all keys in the CIF</span>
            <span class="c1"># data looking for lists, which indicates</span>
            <span class="c1"># multiple data items, one for each row, and remove items from the</span>
            <span class="c1"># list that corresponds to the removed row,</span>
            <span class="c1"># so that it&#39;s not processed by the rest of this function (which</span>
            <span class="c1"># would result in an error).</span>
            <span class="k">for</span> <span class="n">original_key</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">original_key</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">idxs_to_remove</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                        <span class="k">del</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">original_key</span><span class="p">][</span><span class="nb">id</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxs_to_remove</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Pauling file corrections applied.&quot;</span><span class="p">)</span>

                <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_label&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">new_atom_site_label</span>
                <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_type_symbol&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">new_atom_site_type_symbol</span>
                <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_occupancy&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">new_atom_site_occupancy</span>
                <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_fract_x&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">new_fract_x</span>
                <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_fract_y&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">new_fract_y</span>
                <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_fract_z&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">new_fract_z</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This fixes inconsistencies in naming of several magCIF tags</span>
<span class="sd">        as a result of magCIF being in widespread use prior to</span>
<span class="sd">        specification being finalized (on advice of Branton Campbell).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_flags</span><span class="p">[</span><span class="s2">&quot;magcif&quot;</span><span class="p">]:</span>

            <span class="c1"># CIF-1 style has all underscores, interim standard</span>
            <span class="c1"># had period before magn instead of before the final</span>
            <span class="c1"># component (e.g. xyz)</span>
            <span class="c1"># we want to standardize on a specific key, to simplify</span>
            <span class="c1"># parsing code</span>
            <span class="n">correct_keys</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;_space_group_symop_magn_operation.xyz&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_space_group_symop_magn_centering.xyz&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_space_group_magn.name_BNS&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_space_group_magn.number_BNS&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_atom_site_moment_crystalaxis_x&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_atom_site_moment_crystalaxis_y&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_atom_site_moment_crystalaxis_z&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_atom_site_moment_label&quot;</span><span class="p">,</span>
            <span class="p">]</span>

            <span class="c1"># cannot mutate dict during enumeration, so store changes we want to make</span>
            <span class="n">changes_to_make</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">original_key</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">correct_key</span> <span class="ow">in</span> <span class="n">correct_keys</span><span class="p">:</span>
                    <span class="c1"># convert to all underscore</span>
                    <span class="n">trial_key</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">correct_key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">))</span>
                    <span class="n">test_key</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">original_key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">trial_key</span> <span class="o">==</span> <span class="n">test_key</span><span class="p">:</span>
                        <span class="n">changes_to_make</span><span class="p">[</span><span class="n">correct_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_key</span>

            <span class="c1"># make changes</span>
            <span class="k">for</span> <span class="n">correct_key</span><span class="p">,</span> <span class="n">original_key</span> <span class="ow">in</span> <span class="n">changes_to_make</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">correct_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">original_key</span><span class="p">]</span>

            <span class="c1"># renamed_keys maps interim_keys to final_keys</span>
            <span class="n">renamed_keys</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;_magnetic_space_group.transform_to_standard_Pp_abc&quot;</span><span class="p">:</span> <span class="s2">&quot;_space_group_magn.transform_BNS_Pp_abc&quot;</span>
            <span class="p">}</span>
            <span class="n">changes_to_make</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">interim_key</span><span class="p">,</span> <span class="n">final_key</span> <span class="ow">in</span> <span class="n">renamed_keys</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">interim_key</span><span class="p">):</span>
                    <span class="n">changes_to_make</span><span class="p">[</span><span class="n">final_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">interim_key</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">changes_to_make</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Keys changed to match new magCIF specification.&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">final_key</span><span class="p">,</span> <span class="n">interim_key</span> <span class="ow">in</span> <span class="n">changes_to_make</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">final_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">interim_key</span><span class="p">]</span>

        <span class="c1"># check for finite precision frac coordinates (e.g. 0.6667 instead of 0.6666666...7)</span>
        <span class="c1"># this can sometimes cause serious issues when applying symmetry operations</span>
        <span class="n">important_fracs</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span>
        <span class="n">fracs_to_change</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;_atom_site_fract_x&quot;</span><span class="p">,</span> <span class="s2">&quot;_atom_site_fract_y&quot;</span><span class="p">,</span> <span class="s2">&quot;_atom_site_fract_z&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">frac</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">label</span><span class="p">]):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">frac</span> <span class="o">=</span> <span class="n">str2float</span><span class="p">(</span><span class="n">frac</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="c1"># coordinate might not be defined e.g. &#39;?&#39;</span>
                        <span class="k">continue</span>
                    <span class="k">for</span> <span class="n">comparison_frac</span> <span class="ow">in</span> <span class="n">important_fracs</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">frac</span> <span class="o">/</span> <span class="n">comparison_frac</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-4</span><span class="p">:</span>
                            <span class="n">fracs_to_change</span><span class="p">[(</span><span class="n">label</span><span class="p">,</span> <span class="n">idx</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">comparison_frac</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fracs_to_change</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;Some fractional coordinates rounded to ideal values to avoid issues with finite precision.&quot;</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">fracs_to_change</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">_unique_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords_in</span><span class="p">,</span> <span class="n">magmoms_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lattice</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate unique coordinates using coord and symmetry positions</span>
<span class="sd">        and also their corresponding magnetic moments, if supplied.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">magmoms_in</span><span class="p">:</span>
            <span class="n">magmoms</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">magmoms_in</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords_in</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
            <span class="k">for</span> <span class="n">tmp_coord</span><span class="p">,</span> <span class="n">tmp_magmom</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coords_in</span><span class="p">,</span> <span class="n">magmoms_in</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_operations</span><span class="p">:</span>
                    <span class="n">coord</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">operate</span><span class="p">(</span><span class="n">tmp_coord</span><span class="p">)</span>
                    <span class="n">coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">coord</span><span class="p">])</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">MagSymmOp</span><span class="p">):</span>
                        <span class="c1"># Up to this point, magmoms have been defined relative</span>
                        <span class="c1"># to crystal axis. Now convert to Cartesian and into</span>
                        <span class="c1"># a Magmom object.</span>
                        <span class="n">magmom</span> <span class="o">=</span> <span class="n">Magmom</span><span class="o">.</span><span class="n">from_moment_relative_to_crystal_axes</span><span class="p">(</span>
                            <span class="n">op</span><span class="o">.</span><span class="n">operate_magmom</span><span class="p">(</span><span class="n">tmp_magmom</span><span class="p">),</span> <span class="n">lattice</span><span class="o">=</span><span class="n">lattice</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">magmom</span> <span class="o">=</span> <span class="n">Magmom</span><span class="p">(</span><span class="n">tmp_magmom</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">in_coord_list_pbc</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">coord</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_site_tolerance</span><span class="p">):</span>
                        <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
                        <span class="n">magmoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magmom</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">coords</span><span class="p">,</span> <span class="n">magmoms</span>

        <span class="k">for</span> <span class="n">tmp_coord</span> <span class="ow">in</span> <span class="n">coords_in</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_operations</span><span class="p">:</span>
                <span class="n">coord</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">operate</span><span class="p">(</span><span class="n">tmp_coord</span><span class="p">)</span>
                <span class="n">coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">coord</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">in_coord_list_pbc</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">coord</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_site_tolerance</span><span class="p">):</span>
                    <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">coords</span><span class="p">,</span> <span class="p">[</span><span class="n">Magmom</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>  <span class="c1"># return dummy magmoms</span>

    <span class="k">def</span> <span class="nf">get_lattice</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">length_strings</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">),</span>
        <span class="n">angle_strings</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">,</span> <span class="s2">&quot;gamma&quot;</span><span class="p">),</span>
        <span class="n">lattice_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate the lattice from the provided lattice parameters. In</span>
<span class="sd">        the absence of all six lattice parameters, the crystal system</span>
<span class="sd">        and necessary parameters are parsed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="n">str2float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_cell_length_&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">length_strings</span><span class="p">]</span>
            <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="n">str2float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_cell_angle_&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">angle_strings</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lattice_type</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Lattice</span><span class="o">.</span><span class="n">from_parameters</span><span class="p">(</span><span class="o">*</span><span class="n">lengths</span><span class="p">,</span> <span class="o">*</span><span class="n">angles</span><span class="p">)</span>

            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">Lattice</span><span class="p">,</span> <span class="n">lattice_type</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">lengths</span> <span class="o">+</span> <span class="n">angles</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># Missing Key search for cell setting</span>
            <span class="k">for</span> <span class="n">lattice_lable</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;_symmetry_cell_setting&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_space_group_crystal_system&quot;</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lattice_lable</span><span class="p">):</span>
                    <span class="n">lattice_type</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lattice_lable</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">try</span><span class="p">:</span>

                        <span class="n">required_args</span> <span class="o">=</span> <span class="n">getargspec</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">Lattice</span><span class="p">,</span> <span class="n">lattice_type</span><span class="p">))</span><span class="o">.</span><span class="n">args</span>

                        <span class="n">lengths</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">length_strings</span> <span class="k">if</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">required_args</span><span class="p">)</span>
                        <span class="n">angles</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">angle_strings</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">required_args</span><span class="p">)</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lattice</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">lengths</span><span class="p">,</span> <span class="n">angles</span><span class="p">,</span> <span class="n">lattice_type</span><span class="o">=</span><span class="n">lattice_type</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_symops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        In order to generate symmetry equivalent positions, the symmetry</span>
<span class="sd">        operations are parsed. If the symops are not present, the space</span>
<span class="sd">        group symbol is parsed, and symops are generated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">symops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">symmetry_label</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;_symmetry_equiv_pos_as_xyz&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_symmetry_equiv_pos_as_xyz_&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_space_group_symop_operation_xyz&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_space_group_symop_operation_xyz_&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symmetry_label</span><span class="p">):</span>
                <span class="n">xyz</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symmetry_label</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;A 1-line symmetry op P1 CIF is detected!&quot;</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">xyz</span> <span class="o">=</span> <span class="p">[</span><span class="n">xyz</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">symops</span> <span class="o">=</span> <span class="p">[</span><span class="n">SymmOp</span><span class="o">.</span><span class="n">from_xyz_string</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">xyz</span><span class="p">]</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">symops</span><span class="p">:</span>
            <span class="c1"># Try to parse symbol</span>
            <span class="k">for</span> <span class="n">symmetry_label</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;_symmetry_space_group_name_H-M&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_symmetry_space_group_name_H_M&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_symmetry_space_group_name_H-M_&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_symmetry_space_group_name_H_M_&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_space_group_name_Hall&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_space_group_name_Hall_&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_space_group_name_H-M_alt&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_space_group_name_H-M_alt_&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_symmetry_space_group_name_hall&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_symmetry_space_group_name_hall_&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_symmetry_space_group_name_h-m&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_symmetry_space_group_name_h-m_&quot;</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="n">sg</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symmetry_label</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">sg</span><span class="p">:</span>
                    <span class="n">sg</span> <span class="o">=</span> <span class="n">sub_spgrp</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">spg</span> <span class="o">=</span> <span class="n">space_groups</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">spg</span><span class="p">:</span>
                            <span class="n">symops</span> <span class="o">=</span> <span class="n">SpaceGroup</span><span class="p">(</span><span class="n">spg</span><span class="p">)</span><span class="o">.</span><span class="n">symmetry_ops</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="s2">&quot;No _symmetry_equiv_pos_as_xyz type key found. &quot;</span>
                                <span class="s2">&quot;Spacegroup from </span><span class="si">%s</span><span class="s2"> used.&quot;</span> <span class="o">%</span> <span class="n">symmetry_label</span>
                            <span class="p">)</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                            <span class="k">break</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="c1"># Ignore any errors</span>
                        <span class="k">pass</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">_get_cod_data</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">sg</span> <span class="o">==</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;hermann_mauguin&quot;</span><span class="p">]):</span>
                                <span class="n">xyz</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;symops&quot;</span><span class="p">]</span>
                                <span class="n">symops</span> <span class="o">=</span> <span class="p">[</span><span class="n">SymmOp</span><span class="o">.</span><span class="n">from_xyz_string</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">xyz</span><span class="p">]</span>
                                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="s2">&quot;No _symmetry_equiv_pos_as_xyz type key found. &quot;</span>
                                    <span class="s2">&quot;Spacegroup from </span><span class="si">%s</span><span class="s2"> used.&quot;</span> <span class="o">%</span> <span class="n">symmetry_label</span>
                                <span class="p">)</span>
                                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                                <span class="k">break</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">symops</span><span class="p">:</span>
                        <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">symops</span><span class="p">:</span>
            <span class="c1"># Try to parse International number</span>
            <span class="k">for</span> <span class="n">symmetry_label</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;_space_group_IT_number&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_space_group_IT_number_&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_symmetry_Int_Tables_number&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_symmetry_Int_Tables_number_&quot;</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symmetry_label</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">str2float</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symmetry_label</span><span class="p">)))</span>
                        <span class="n">symops</span> <span class="o">=</span> <span class="n">SpaceGroup</span><span class="o">.</span><span class="n">from_int_number</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">symmetry_ops</span>
                        <span class="k">break</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">continue</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">symops</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No _symmetry_equiv_pos_as_xyz type key found. Defaulting to P1.&quot;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">symops</span> <span class="o">=</span> <span class="p">[</span><span class="n">SymmOp</span><span class="o">.</span><span class="n">from_xyz_string</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]]</span>

        <span class="k">return</span> <span class="n">symops</span>

    <span class="k">def</span> <span class="nf">get_magsymops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Equivalent to get_symops except for magnetic symmetry groups.</span>
<span class="sd">        Separate function since additional operation for time reversal symmetry</span>
<span class="sd">        (which changes magnetic moments on sites) needs to be returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">magsymmops</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># check to see if magCIF file explicitly contains magnetic symmetry operations</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_space_group_symop_magn_operation.xyz&quot;</span><span class="p">):</span>

            <span class="n">xyzt</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_space_group_symop_magn_operation.xyz&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xyzt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">xyzt</span> <span class="o">=</span> <span class="p">[</span><span class="n">xyzt</span><span class="p">]</span>
            <span class="n">magsymmops</span> <span class="o">=</span> <span class="p">[</span><span class="n">MagSymmOp</span><span class="o">.</span><span class="n">from_xyzt_string</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">xyzt</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_space_group_symop_magn_centering.xyz&quot;</span><span class="p">):</span>

                <span class="n">xyzt</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_space_group_symop_magn_centering.xyz&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xyzt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">xyzt</span> <span class="o">=</span> <span class="p">[</span><span class="n">xyzt</span><span class="p">]</span>
                <span class="n">centering_symops</span> <span class="o">=</span> <span class="p">[</span><span class="n">MagSymmOp</span><span class="o">.</span><span class="n">from_xyzt_string</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">xyzt</span><span class="p">]</span>

                <span class="n">all_ops</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">magsymmops</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">centering_op</span> <span class="ow">in</span> <span class="n">centering_symops</span><span class="p">:</span>
                        <span class="n">new_translation</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">i</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">translation_vector</span> <span class="o">+</span> <span class="n">centering_op</span><span class="o">.</span><span class="n">translation_vector</span>
                        <span class="p">]</span>
                        <span class="n">new_time_reversal</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">time_reversal</span> <span class="o">*</span> <span class="n">centering_op</span><span class="o">.</span><span class="n">time_reversal</span>
                        <span class="n">all_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">MagSymmOp</span><span class="o">.</span><span class="n">from_rotation_and_translation_and_time_reversal</span><span class="p">(</span>
                                <span class="n">rotation_matrix</span><span class="o">=</span><span class="n">op</span><span class="o">.</span><span class="n">rotation_matrix</span><span class="p">,</span>
                                <span class="n">translation_vec</span><span class="o">=</span><span class="n">new_translation</span><span class="p">,</span>
                                <span class="n">time_reversal</span><span class="o">=</span><span class="n">new_time_reversal</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                <span class="n">magsymmops</span> <span class="o">=</span> <span class="n">all_ops</span>

        <span class="c1"># else check to see if it specifies a magnetic space group</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_space_group_magn.name_BNS&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_space_group_magn.number_BNS&quot;</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_space_group_magn.name_BNS&quot;</span><span class="p">):</span>
                <span class="c1"># get BNS label for MagneticSpaceGroup()</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_space_group_magn.name_BNS&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># get BNS number for MagneticSpaceGroup()</span>
                <span class="c1"># by converting string to list of ints</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_space_group_magn.number_BNS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">))))</span>

            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_space_group_magn.transform_BNS_Pp_abc&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_space_group_magn.transform_BNS_Pp_abc&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;a,b,c;0,0,0&quot;</span><span class="p">:</span>

                    <span class="n">jf</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_space_group_magn.transform_BNS_Pp_abc&quot;</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">MagneticSpaceGroup</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">jf</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_space_group_magn.transform_BNS_Pp&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Incomplete specification to implement.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">MagneticSpaceGroup</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

            <span class="n">magsymmops</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">symmetry_ops</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">magsymmops</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No magnetic symmetry detected, using primitive symmetry.&quot;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">magsymmops</span> <span class="o">=</span> <span class="p">[</span><span class="n">MagSymmOp</span><span class="o">.</span><span class="n">from_xyzt_string</span><span class="p">(</span><span class="s2">&quot;x, y, z, 1&quot;</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">magsymmops</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parse_oxi_states</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse oxidation states from data dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">oxi_states</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_type_symbol&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span> <span class="n">str2float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_type_oxidation_number&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_type_symbol&quot;</span><span class="p">]))</span>
            <span class="p">}</span>
            <span class="c1"># attempt to strip oxidation state from _atom_type_symbol</span>
            <span class="c1"># in case the label does not contain an oxidation state</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_type_symbol&quot;</span><span class="p">]):</span>
                <span class="n">oxi_states</span><span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d?[\+,\-]?$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)]</span> <span class="o">=</span> <span class="n">str2float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_type_oxidation_number&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
            <span class="n">oxi_states</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">oxi_states</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parse_magmoms</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">lattice</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse atomic magnetic moments from data dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">lattice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Magmoms given in terms of crystal axes in magCIF spec.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">magmoms</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_moment_label&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">str2float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_moment_crystalaxis_x&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]),</span>
                        <span class="n">str2float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_moment_crystalaxis_y&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]),</span>
                        <span class="n">str2float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_moment_crystalaxis_z&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]),</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_moment_label&quot;</span><span class="p">]))</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">magmoms</span>

    <span class="k">def</span> <span class="nf">_parse_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sym</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse a string with a symbol to extract a string representing an element.</span>

<span class="sd">        Args:</span>
<span class="sd">            sym (str): A symbol to be parsed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A string with the parsed symbol. None if no parsing was possible.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Common representations for elements/water in cif files</span>
        <span class="c1"># TODO: fix inconsistent handling of water</span>
        <span class="n">special</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Hw&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Ow&quot;</span><span class="p">:</span> <span class="s2">&quot;O&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Wat&quot;</span><span class="p">:</span> <span class="s2">&quot;O&quot;</span><span class="p">,</span>
            <span class="s2">&quot;wat&quot;</span><span class="p">:</span> <span class="s2">&quot;O&quot;</span><span class="p">,</span>
            <span class="s2">&quot;OH&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;OH2&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;NO3&quot;</span><span class="p">:</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">parsed_sym</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># try with special symbols, otherwise check the first two letters,</span>
        <span class="c1"># then the first letter alone. If everything fails try extracting the</span>
        <span class="c1"># first letters.</span>
        <span class="n">m_sp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">special</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">sym</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m_sp</span><span class="p">:</span>
            <span class="n">parsed_sym</span> <span class="o">=</span> <span class="n">special</span><span class="p">[</span><span class="n">m_sp</span><span class="o">.</span><span class="n">group</span><span class="p">()]</span>
        <span class="k">elif</span> <span class="n">Element</span><span class="o">.</span><span class="n">is_valid_symbol</span><span class="p">(</span><span class="n">sym</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="p">()):</span>
            <span class="n">parsed_sym</span> <span class="o">=</span> <span class="n">sym</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">Element</span><span class="o">.</span><span class="n">is_valid_symbol</span><span class="p">(</span><span class="n">sym</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()):</span>
            <span class="n">parsed_sym</span> <span class="o">=</span> <span class="n">sym</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;w?[A-Z][a-z]*&quot;</span><span class="p">,</span> <span class="n">sym</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">parsed_sym</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">parsed_sym</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">m_sp</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">rf</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parsed_sym</span><span class="si">}</span><span class="s2">\d*&quot;</span><span class="p">,</span> <span class="n">sym</span><span class="p">)):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2"> parsed as </span><span class="si">{</span><span class="n">parsed_sym</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">parsed_sym</span>

    <span class="k">def</span> <span class="nf">_get_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">primitive</span><span class="p">,</span> <span class="n">symmetrized</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate structure from part of the cif.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">get_num_implicit_hydrogens</span><span class="p">(</span><span class="n">sym</span><span class="p">):</span>
            <span class="n">num_h</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Wat&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;wat&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;O-H&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">num_h</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sym</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">lattice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lattice</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># if magCIF, get magnetic symmetry moments and magmoms</span>
        <span class="c1"># else standard CIF, and use empty magmom dict</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_flags</span><span class="p">[</span><span class="s2">&quot;magcif_incommensurate&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Incommensurate structures not currently supported.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_flags</span><span class="p">[</span><span class="s2">&quot;magcif&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_operations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_magsymops</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">magmoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_magmoms</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">lattice</span><span class="o">=</span><span class="n">lattice</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_operations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symops</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">magmoms</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">oxi_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_oxi_states</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="n">coord_to_species</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">coord_to_magmoms</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">get_matching_coord</span><span class="p">(</span><span class="n">coord</span><span class="p">):</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">coord_to_species</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_operations</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">operate</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
                <span class="n">inds</span> <span class="o">=</span> <span class="n">find_in_coord_list_pbc</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_site_tolerance</span><span class="p">)</span>
                <span class="c1"># can&#39;t use if inds, because python is dumb and np.array([0]) evaluates</span>
                <span class="c1"># to False</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">keys</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_label&quot;</span><span class="p">])):</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># If site type symbol exists, use it. Otherwise, we use the</span>
                <span class="c1"># label.</span>
                <span class="n">symbol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_symbol</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_type_symbol&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                <span class="n">num_h</span> <span class="o">=</span> <span class="n">get_num_implicit_hydrogens</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_type_symbol&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">symbol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_symbol</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_label&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                <span class="n">num_h</span> <span class="o">=</span> <span class="n">get_num_implicit_hydrogens</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_label&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">symbol</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">oxi_states</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">o_s</span> <span class="o">=</span> <span class="n">oxi_states</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="c1"># use _atom_site_type_symbol if possible for oxidation state</span>
                <span class="k">if</span> <span class="s2">&quot;_atom_site_type_symbol&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">oxi_symbol</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_type_symbol&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">o_s</span> <span class="o">=</span> <span class="n">oxi_states</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">oxi_symbol</span><span class="p">,</span> <span class="n">o_s</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">el</span> <span class="o">=</span> <span class="n">Species</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">o_s</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">el</span> <span class="o">=</span> <span class="n">DummySpecies</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">o_s</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">el</span> <span class="o">=</span> <span class="n">get_el_sp</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">str2float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_fract_x&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">str2float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_fract_y&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">str2float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_fract_z&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="n">magmom</span> <span class="o">=</span> <span class="n">magmoms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_label&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">occu</span> <span class="o">=</span> <span class="n">str2float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_occupancy&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">occu</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">occu</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">coord</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">get_matching_coord</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
                <span class="n">comp_d</span> <span class="o">=</span> <span class="p">{</span><span class="n">el</span><span class="p">:</span> <span class="n">occu</span><span class="p">}</span>
                <span class="k">if</span> <span class="n">num_h</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">comp_d</span><span class="p">[</span><span class="s2">&quot;H&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_h</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s2">&quot;Structure has implicit hydrogens defined, &quot;</span>
                        <span class="s2">&quot;parsed structure unlikely to be suitable for use &quot;</span>
                        <span class="s2">&quot;in calculations unless hydrogens added.&quot;</span>
                    <span class="p">)</span>
                <span class="n">comp</span> <span class="o">=</span> <span class="n">Composition</span><span class="p">(</span><span class="n">comp_d</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
                    <span class="n">coord_to_species</span><span class="p">[</span><span class="n">coord</span><span class="p">]</span> <span class="o">=</span> <span class="n">comp</span>
                    <span class="n">coord_to_magmoms</span><span class="p">[</span><span class="n">coord</span><span class="p">]</span> <span class="o">=</span> <span class="n">magmom</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">coord_to_species</span><span class="p">[</span><span class="n">match</span><span class="p">]</span> <span class="o">+=</span> <span class="n">comp</span>
                    <span class="c1"># disordered magnetic not currently supported</span>
                    <span class="n">coord_to_magmoms</span><span class="p">[</span><span class="n">match</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">sum_occu</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">sum</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coord_to_species</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;O&quot;</span><span class="p">),</span> <span class="n">Element</span><span class="p">(</span><span class="s2">&quot;H&quot;</span><span class="p">)}</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">o</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">sum_occu</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Some occupancies (</span><span class="si">{}</span><span class="s2">) sum to &gt; 1! If they are within &quot;</span>
                <span class="s2">&quot;the occupancy_tolerance, they will be rescaled. &quot;</span>
                <span class="s2">&quot;The current occupancy_tolerance is set to: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sum_occu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occupancy_tolerance</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">allspecies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">allcoords</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">allmagmoms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">allhydrogens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">equivalent_indices</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># check to see if magCIF file is disordered</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_flags</span><span class="p">[</span><span class="s2">&quot;magcif&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">coord_to_magmoms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Proposed solution to this is to instead store magnetic</span>
                    <span class="c1"># moments as Species &#39;spin&#39; property, instead of site</span>
                    <span class="c1"># property, but this introduces ambiguities for end user</span>
                    <span class="c1"># (such as unintended use of `spin` and Species will have</span>
                    <span class="c1"># fictitious oxidation state).</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Disordered magnetic structures not currently supported.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">coord_to_species</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                <span class="n">groupby</span><span class="p">(</span>
                    <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">coord_to_species</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="n">tmp_coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">site</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">group</span><span class="p">]</span>
                <span class="n">tmp_magmom</span> <span class="o">=</span> <span class="p">[</span><span class="n">coord_to_magmoms</span><span class="p">[</span><span class="n">tmp_coord</span><span class="p">]</span> <span class="k">for</span> <span class="n">tmp_coord</span> <span class="ow">in</span> <span class="n">tmp_coords</span><span class="p">]</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_flags</span><span class="p">[</span><span class="s2">&quot;magcif&quot;</span><span class="p">]:</span>
                    <span class="n">coords</span><span class="p">,</span> <span class="n">magmoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unique_coords</span><span class="p">(</span><span class="n">tmp_coords</span><span class="p">,</span> <span class="n">magmoms_in</span><span class="o">=</span><span class="n">tmp_magmom</span><span class="p">,</span> <span class="n">lattice</span><span class="o">=</span><span class="n">lattice</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">coords</span><span class="p">,</span> <span class="n">magmoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unique_coords</span><span class="p">(</span><span class="n">tmp_coords</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;O&quot;</span><span class="p">),</span> <span class="n">Element</span><span class="p">(</span><span class="s2">&quot;H&quot;</span><span class="p">)}:</span>
                    <span class="c1"># O with implicit hydrogens</span>
                    <span class="n">im_h</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="s2">&quot;H&quot;</span><span class="p">]</span>
                    <span class="n">species</span> <span class="o">=</span> <span class="n">Composition</span><span class="p">({</span><span class="s2">&quot;O&quot;</span><span class="p">:</span> <span class="n">comp</span><span class="p">[</span><span class="s2">&quot;O&quot;</span><span class="p">]})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">im_h</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">species</span> <span class="o">=</span> <span class="n">comp</span>

                <span class="c1"># The following might be a more natural representation of equivalent indices,</span>
                <span class="c1"># but is not in the format expect by SymmetrizedStructure:</span>
                <span class="c1">#   equivalent_indices.append(list(range(len(allcoords), len(coords)+len(allcoords))))</span>
                <span class="c1"># The above gives a list like:</span>
                <span class="c1">#   [[0, 1, 2, 3], [4, 5, 6, 7, 8, 9, 10, 11]] where the</span>
                <span class="c1"># integers are site indices, whereas the version used below will give a version like:</span>
                <span class="c1">#   [0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1]</span>
                <span class="c1"># which is a list in the same order as the sites, but where if a site has the same integer</span>
                <span class="c1"># it is equivalent.</span>
                <span class="n">equivalent_indices</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">*</span> <span class="p">[</span><span class="n">idx</span><span class="p">]</span>

                <span class="n">allhydrogens</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">*</span> <span class="p">[</span><span class="n">im_h</span><span class="p">])</span>
                <span class="n">allcoords</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
                <span class="n">allspecies</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">*</span> <span class="p">[</span><span class="n">species</span><span class="p">])</span>
                <span class="n">allmagmoms</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">magmoms</span><span class="p">)</span>

            <span class="c1"># rescale occupancies if necessary</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">species</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">allspecies</span><span class="p">):</span>
                <span class="n">totaloccu</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">totaloccu</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occupancy_tolerance</span><span class="p">:</span>
                    <span class="n">allspecies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">species</span> <span class="o">/</span> <span class="n">totaloccu</span>

        <span class="k">if</span> <span class="n">allspecies</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">allspecies</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">allcoords</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">allspecies</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">allmagmoms</span><span class="p">):</span>
            <span class="n">site_properties</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">allhydrogens</span><span class="p">):</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">allhydrogens</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">allcoords</span><span class="p">)</span>
                <span class="n">site_properties</span><span class="p">[</span><span class="s2">&quot;implicit_hydrogens&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">allhydrogens</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_flags</span><span class="p">[</span><span class="s2">&quot;magcif&quot;</span><span class="p">]:</span>
                <span class="n">site_properties</span><span class="p">[</span><span class="s2">&quot;magmom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">allmagmoms</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">site_properties</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">site_properties</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">struct</span> <span class="o">=</span> <span class="n">Structure</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">allspecies</span><span class="p">,</span> <span class="n">allcoords</span><span class="p">,</span> <span class="n">site_properties</span><span class="o">=</span><span class="n">site_properties</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">symmetrized</span><span class="p">:</span>

                <span class="c1"># Wyckoff labels not currently parsed, note that not all CIFs will contain Wyckoff labels</span>
                <span class="c1"># TODO: extract Wyckoff labels (or other CIF attributes) and include as site_properties</span>
                <span class="n">wyckoffs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Not Parsed&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">struct</span><span class="p">)</span>

                <span class="c1"># Names of space groups are likewise not parsed (again, not all CIFs will contain this information)</span>
                <span class="c1"># What is stored are the lists of symmetry operations used to generate the structure</span>
                <span class="c1"># TODO: ensure space group labels are stored if present</span>
                <span class="n">sg</span> <span class="o">=</span> <span class="n">SpacegroupOperations</span><span class="p">(</span><span class="s2">&quot;Not Parsed&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_operations</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">SymmetrizedStructure</span><span class="p">(</span><span class="n">struct</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">equivalent_indices</span><span class="p">,</span> <span class="n">wyckoffs</span><span class="p">)</span>

            <span class="n">struct</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">get_sorted_structure</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">primitive</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_flags</span><span class="p">[</span><span class="s2">&quot;magcif&quot;</span><span class="p">]:</span>
                <span class="n">struct</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">get_primitive_structure</span><span class="p">(</span><span class="n">use_site_props</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">primitive</span><span class="p">:</span>
                <span class="n">struct</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">get_primitive_structure</span><span class="p">()</span>
                <span class="n">struct</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">get_reduced_structure</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">struct</span>

    <span class="k">def</span> <span class="nf">get_structures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">primitive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">symmetrized</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return list of structures in CIF file. primitive boolean sets whether a</span>
<span class="sd">        conventional cell structure or primitive cell structure is returned.</span>

<span class="sd">        Args:</span>
<span class="sd">            primitive (bool): Set to False to return conventional unit cells.</span>
<span class="sd">                Defaults to True. With magnetic CIF files, will return primitive</span>
<span class="sd">                magnetic cell which may be larger than nuclear primitive cell.</span>
<span class="sd">            symmetrized (bool): If True, return a SymmetrizedStructure which will</span>
<span class="sd">                include the equivalent indices and symmetry operations used to</span>
<span class="sd">                create the Structure as provided by the CIF (if explicit symmetry</span>
<span class="sd">                operations are included in the CIF) or generated from information</span>
<span class="sd">                in the CIF (if only space group labels are provided). Note that</span>
<span class="sd">                currently Wyckoff labels and space group labels or numbers are</span>
<span class="sd">                not included in the generated SymmetrizedStructure, these will be</span>
<span class="sd">                notated as &quot;Not Parsed&quot; or -1 respectively.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of Structures.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">primitive</span> <span class="ow">and</span> <span class="n">symmetrized</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Using both &#39;primitive&#39; and &#39;symmetrized&#39; arguments is not currently supported &quot;</span>
                <span class="s2">&quot;since unexpected behavior might result.&quot;</span>
            <span class="p">)</span>

        <span class="n">structures</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cif</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_structure</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">primitive</span><span class="p">,</span> <span class="n">symmetrized</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                    <span class="n">structures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="c1"># Warn the user (Errors should never pass silently)</span>
                <span class="c1"># A user reported a problem with cif files produced by Avogadro</span>
                <span class="c1"># in which the atomic coordinates are in Cartesian coords.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No structure parsed for </span><span class="si">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2"> structure in CIF. Section of CIF file below.&quot;</span><span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error is </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Issues encountered while parsing CIF: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">structures</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid cif file with no structures!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">structures</span>

    <span class="k">def</span> <span class="nf">get_bibtex_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get BibTeX reference from CIF file.</span>
<span class="sd">        :param data:</span>
<span class="sd">        :return: BibTeX string</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">pybtex.database</span> <span class="kn">import</span> <span class="n">BibliographyData</span><span class="p">,</span> <span class="n">Entry</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Bibliographic data extraction requires pybtex.&quot;</span><span class="p">)</span>

        <span class="n">bibtex_keys</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;author&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;_publ_author_name&quot;</span><span class="p">,</span> <span class="s2">&quot;_citation_author_name&quot;</span><span class="p">),</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;_publ_section_title&quot;</span><span class="p">,</span> <span class="s2">&quot;_citation_title&quot;</span><span class="p">),</span>
            <span class="s2">&quot;journal&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="s2">&quot;_journal_name_full&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_journal_name_abbrev&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_citation_journal_full&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_citation_journal_abbrev&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;_journal_volume&quot;</span><span class="p">,</span> <span class="s2">&quot;_citation_journal_volume&quot;</span><span class="p">),</span>
            <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;_journal_year&quot;</span><span class="p">,</span> <span class="s2">&quot;_citation_year&quot;</span><span class="p">),</span>
            <span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;_journal_number&quot;</span><span class="p">,</span> <span class="s2">&quot;_citation_number&quot;</span><span class="p">),</span>
            <span class="s2">&quot;page_first&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;_journal_page_first&quot;</span><span class="p">,</span> <span class="s2">&quot;_citation_page_first&quot;</span><span class="p">),</span>
            <span class="s2">&quot;page_last&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;_journal_page_last&quot;</span><span class="p">,</span> <span class="s2">&quot;_citation_page_last&quot;</span><span class="p">),</span>
            <span class="s2">&quot;doi&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;_journal_DOI&quot;</span><span class="p">,</span> <span class="s2">&quot;_citation_DOI&quot;</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="n">entries</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># TODO: parse &#39;_publ_section_references&#39; when it exists?</span>
        <span class="c1"># TODO: CIF specification supports multiple citations.</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cif</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>

            <span class="c1"># convert to lower-case keys, some cif files inconsistent</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

            <span class="n">bibtex_entry</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">tags</span> <span class="ow">in</span> <span class="n">bibtex_keys</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">tag</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">bibtex_entry</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">tag</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">bibtex_entry</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>

            <span class="c1"># convert to bibtex author format (&#39;and&#39; delimited)</span>
            <span class="k">if</span> <span class="s2">&quot;author&quot;</span> <span class="ow">in</span> <span class="n">bibtex_entry</span><span class="p">:</span>
                <span class="c1"># separate out semicolon authors</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bibtex_entry</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s2">&quot;;&quot;</span> <span class="ow">in</span> <span class="n">bibtex_entry</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">]:</span>
                        <span class="n">bibtex_entry</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bibtex_entry</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bibtex_entry</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">bibtex_entry</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; and &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bibtex_entry</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">])</span>

            <span class="c1"># convert to bibtex page range format, use empty string if not specified</span>
            <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;page_first&quot;</span> <span class="ow">in</span> <span class="n">bibtex_entry</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;page_last&quot;</span> <span class="ow">in</span> <span class="n">bibtex_entry</span><span class="p">):</span>
                <span class="n">bibtex_entry</span><span class="p">[</span><span class="s2">&quot;pages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">--</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">bibtex_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;page_first&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                    <span class="n">bibtex_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;page_last&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">bibtex_entry</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;page_first&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># and remove page_first, page_list if present</span>
                <span class="n">bibtex_entry</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;page_last&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="c1"># cite keys are given as cif-reference-idx in order they are found</span>
            <span class="n">entries</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;cifref</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Entry</span><span class="p">(</span><span class="s2">&quot;article&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">bibtex_entry</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>

        <span class="k">return</span> <span class="n">BibliographyData</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">bib_format</span><span class="o">=</span><span class="s2">&quot;bibtex&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: MSONable dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cif</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k2</span><span class="p">,</span> <span class="n">v2</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">k2</span><span class="p">]</span> <span class="o">=</span> <span class="n">v2</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: Whether there are errors/warnings detected in CIF parsing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</pre></div>

        </details>

            <div class="docstring"><p>Parses a CIF file. Attempts to fix CIFs that are out-of-spec, but will
issue warnings if corrections applied. These are also stored in the
CifParser's errors attribute.</p>
</div>


                            <div id="CifParser.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CifParser.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">CifParser</span><span class="signature">(filename, occupancy_tolerance=1.0, site_tolerance=0.0001)</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">occupancy_tolerance</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">site_tolerance</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            filename (str): CIF filename, bzipped or gzipped CIF files are fine too.</span>
<span class="sd">            occupancy_tolerance (float): If total occupancy of a site is between 1</span>
<span class="sd">                and occupancy_tolerance, the occupancies will be scaled down to 1.</span>
<span class="sd">            site_tolerance (float): This tolerance is used to determine if two</span>
<span class="sd">                sites are sitting in the same position, in which case they will be</span>
<span class="sd">                combined to a single disordered site. Defaults to 1e-4.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_occupancy_tolerance</span> <span class="o">=</span> <span class="n">occupancy_tolerance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_site_tolerance</span> <span class="o">=</span> <span class="n">site_tolerance</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cif</span> <span class="o">=</span> <span class="n">CifFile</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cif</span> <span class="o">=</span> <span class="n">CifFile</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

        <span class="c1"># store if CIF contains features from non-core CIF dictionaries</span>
        <span class="c1"># e.g. magCIF</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_flags</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">is_magcif</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Checks to see if file appears to be a magCIF file (heuristic).</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Doesn&#39;t seem to be a canonical way to test if file is magCIF or</span>
            <span class="c1"># not, so instead check for magnetic symmetry datanames</span>
            <span class="n">prefixes</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;_space_group_magn&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_atom_site_moment&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_space_group_symop_magn&quot;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cif</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">prefixes</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                            <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">feature_flags</span><span class="p">[</span><span class="s2">&quot;magcif&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_magcif</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">is_magcif_incommensurate</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Checks to see if file contains an incommensurate magnetic</span>
<span class="sd">            structure (heuristic).</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Doesn&#39;t seem to be a canonical way to test if magCIF file</span>
            <span class="c1"># describes incommensurate structure or not, so instead check</span>
            <span class="c1"># for common datanames</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_flags</span><span class="p">[</span><span class="s2">&quot;magcif&quot;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">prefixes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;_cell_modulation_dimension&quot;</span><span class="p">,</span> <span class="s2">&quot;_cell_wave_vector&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cif</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">prefixes</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                            <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">feature_flags</span><span class="p">[</span><span class="s2">&quot;magcif_incommensurate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_magcif_incommensurate</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cif</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># pass individual CifBlocks to _sanitize_data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cif</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sanitize_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cif</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
</pre></div>

        </details>

            <div class="docstring"><p>Args:
    filename (str): CIF filename, bzipped or gzipped CIF files are fine too.
    occupancy_tolerance (float): If total occupancy of a site is between 1
        and occupancy_tolerance, the occupancies will be scaled down to 1.
    site_tolerance (float): This tolerance is used to determine if two
        sites are sitting in the same position, in which case they will be
        combined to a single disordered site. Defaults to 1e-4.</p>
</div>


                            </div>
                            <div id="CifParser.from_string" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CifParser.from_string">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>

            <span class="def">def</span>
            <span class="name">from_string</span><span class="signature">(cif_string, occupancy_tolerance=1.0)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_string</span><span class="p">(</span><span class="n">cif_string</span><span class="p">,</span> <span class="n">occupancy_tolerance</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a CifParser from a string.</span>

<span class="sd">        Args:</span>
<span class="sd">            cif_string (str): String representation of a CIF.</span>
<span class="sd">            occupancy_tolerance (float): If total occupancy of a site is</span>
<span class="sd">                between 1 and occupancy_tolerance, the occupancies will be</span>
<span class="sd">                scaled down to 1.</span>

<span class="sd">        Returns:</span>
<span class="sd">            CifParser</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">cif_string</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">CifParser</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">occupancy_tolerance</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Creates a CifParser from a string.</p>

<p>Args:
    cif_string (str): String representation of a CIF.
    occupancy_tolerance (float): If total occupancy of a site is
        between 1 and occupancy_tolerance, the occupancies will be
        scaled down to 1.</p>

<p>Returns:
    CifParser</p>
</div>


                            </div>
                            <div id="CifParser.get_lattice" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CifParser.get_lattice">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_lattice</span><span class="signature">(
    self,
    data,
    length_strings=(&#39;a&#39;, &#39;b&#39;, &#39;c&#39;),
    angle_strings=(&#39;alpha&#39;, &#39;beta&#39;, &#39;gamma&#39;),
    lattice_type=None
)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_lattice</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">length_strings</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">),</span>
        <span class="n">angle_strings</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">,</span> <span class="s2">&quot;gamma&quot;</span><span class="p">),</span>
        <span class="n">lattice_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate the lattice from the provided lattice parameters. In</span>
<span class="sd">        the absence of all six lattice parameters, the crystal system</span>
<span class="sd">        and necessary parameters are parsed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="n">str2float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_cell_length_&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">length_strings</span><span class="p">]</span>
            <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="n">str2float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_cell_angle_&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">angle_strings</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lattice_type</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Lattice</span><span class="o">.</span><span class="n">from_parameters</span><span class="p">(</span><span class="o">*</span><span class="n">lengths</span><span class="p">,</span> <span class="o">*</span><span class="n">angles</span><span class="p">)</span>

            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">Lattice</span><span class="p">,</span> <span class="n">lattice_type</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">lengths</span> <span class="o">+</span> <span class="n">angles</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># Missing Key search for cell setting</span>
            <span class="k">for</span> <span class="n">lattice_lable</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;_symmetry_cell_setting&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_space_group_crystal_system&quot;</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lattice_lable</span><span class="p">):</span>
                    <span class="n">lattice_type</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lattice_lable</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">try</span><span class="p">:</span>

                        <span class="n">required_args</span> <span class="o">=</span> <span class="n">getargspec</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">Lattice</span><span class="p">,</span> <span class="n">lattice_type</span><span class="p">))</span><span class="o">.</span><span class="n">args</span>

                        <span class="n">lengths</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">length_strings</span> <span class="k">if</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">required_args</span><span class="p">)</span>
                        <span class="n">angles</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">angle_strings</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">required_args</span><span class="p">)</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lattice</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">lengths</span><span class="p">,</span> <span class="n">angles</span><span class="p">,</span> <span class="n">lattice_type</span><span class="o">=</span><span class="n">lattice_type</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="kc">None</span>
</pre></div>

        </details>

            <div class="docstring"><p>Generate the lattice from the provided lattice parameters. In
the absence of all six lattice parameters, the crystal system
and necessary parameters are parsed</p>
</div>


                            </div>
                            <div id="CifParser.get_symops" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CifParser.get_symops">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_symops</span><span class="signature">(self, data)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_symops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        In order to generate symmetry equivalent positions, the symmetry</span>
<span class="sd">        operations are parsed. If the symops are not present, the space</span>
<span class="sd">        group symbol is parsed, and symops are generated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">symops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">symmetry_label</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;_symmetry_equiv_pos_as_xyz&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_symmetry_equiv_pos_as_xyz_&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_space_group_symop_operation_xyz&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_space_group_symop_operation_xyz_&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symmetry_label</span><span class="p">):</span>
                <span class="n">xyz</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symmetry_label</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;A 1-line symmetry op P1 CIF is detected!&quot;</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">xyz</span> <span class="o">=</span> <span class="p">[</span><span class="n">xyz</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">symops</span> <span class="o">=</span> <span class="p">[</span><span class="n">SymmOp</span><span class="o">.</span><span class="n">from_xyz_string</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">xyz</span><span class="p">]</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">symops</span><span class="p">:</span>
            <span class="c1"># Try to parse symbol</span>
            <span class="k">for</span> <span class="n">symmetry_label</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;_symmetry_space_group_name_H-M&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_symmetry_space_group_name_H_M&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_symmetry_space_group_name_H-M_&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_symmetry_space_group_name_H_M_&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_space_group_name_Hall&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_space_group_name_Hall_&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_space_group_name_H-M_alt&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_space_group_name_H-M_alt_&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_symmetry_space_group_name_hall&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_symmetry_space_group_name_hall_&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_symmetry_space_group_name_h-m&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_symmetry_space_group_name_h-m_&quot;</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="n">sg</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symmetry_label</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">sg</span><span class="p">:</span>
                    <span class="n">sg</span> <span class="o">=</span> <span class="n">sub_spgrp</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">spg</span> <span class="o">=</span> <span class="n">space_groups</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">spg</span><span class="p">:</span>
                            <span class="n">symops</span> <span class="o">=</span> <span class="n">SpaceGroup</span><span class="p">(</span><span class="n">spg</span><span class="p">)</span><span class="o">.</span><span class="n">symmetry_ops</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="s2">&quot;No _symmetry_equiv_pos_as_xyz type key found. &quot;</span>
                                <span class="s2">&quot;Spacegroup from </span><span class="si">%s</span><span class="s2"> used.&quot;</span> <span class="o">%</span> <span class="n">symmetry_label</span>
                            <span class="p">)</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                            <span class="k">break</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="c1"># Ignore any errors</span>
                        <span class="k">pass</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">_get_cod_data</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">sg</span> <span class="o">==</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;hermann_mauguin&quot;</span><span class="p">]):</span>
                                <span class="n">xyz</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;symops&quot;</span><span class="p">]</span>
                                <span class="n">symops</span> <span class="o">=</span> <span class="p">[</span><span class="n">SymmOp</span><span class="o">.</span><span class="n">from_xyz_string</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">xyz</span><span class="p">]</span>
                                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="s2">&quot;No _symmetry_equiv_pos_as_xyz type key found. &quot;</span>
                                    <span class="s2">&quot;Spacegroup from </span><span class="si">%s</span><span class="s2"> used.&quot;</span> <span class="o">%</span> <span class="n">symmetry_label</span>
                                <span class="p">)</span>
                                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                                <span class="k">break</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">symops</span><span class="p">:</span>
                        <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">symops</span><span class="p">:</span>
            <span class="c1"># Try to parse International number</span>
            <span class="k">for</span> <span class="n">symmetry_label</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;_space_group_IT_number&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_space_group_IT_number_&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_symmetry_Int_Tables_number&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_symmetry_Int_Tables_number_&quot;</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symmetry_label</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">str2float</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symmetry_label</span><span class="p">)))</span>
                        <span class="n">symops</span> <span class="o">=</span> <span class="n">SpaceGroup</span><span class="o">.</span><span class="n">from_int_number</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">symmetry_ops</span>
                        <span class="k">break</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">continue</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">symops</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No _symmetry_equiv_pos_as_xyz type key found. Defaulting to P1.&quot;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">symops</span> <span class="o">=</span> <span class="p">[</span><span class="n">SymmOp</span><span class="o">.</span><span class="n">from_xyz_string</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]]</span>

        <span class="k">return</span> <span class="n">symops</span>
</pre></div>

        </details>

            <div class="docstring"><p>In order to generate symmetry equivalent positions, the symmetry
operations are parsed. If the symops are not present, the space
group symbol is parsed, and symops are generated.</p>
</div>


                            </div>
                            <div id="CifParser.get_magsymops" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CifParser.get_magsymops">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_magsymops</span><span class="signature">(self, data)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_magsymops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Equivalent to get_symops except for magnetic symmetry groups.</span>
<span class="sd">        Separate function since additional operation for time reversal symmetry</span>
<span class="sd">        (which changes magnetic moments on sites) needs to be returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">magsymmops</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># check to see if magCIF file explicitly contains magnetic symmetry operations</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_space_group_symop_magn_operation.xyz&quot;</span><span class="p">):</span>

            <span class="n">xyzt</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_space_group_symop_magn_operation.xyz&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xyzt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">xyzt</span> <span class="o">=</span> <span class="p">[</span><span class="n">xyzt</span><span class="p">]</span>
            <span class="n">magsymmops</span> <span class="o">=</span> <span class="p">[</span><span class="n">MagSymmOp</span><span class="o">.</span><span class="n">from_xyzt_string</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">xyzt</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_space_group_symop_magn_centering.xyz&quot;</span><span class="p">):</span>

                <span class="n">xyzt</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_space_group_symop_magn_centering.xyz&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xyzt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">xyzt</span> <span class="o">=</span> <span class="p">[</span><span class="n">xyzt</span><span class="p">]</span>
                <span class="n">centering_symops</span> <span class="o">=</span> <span class="p">[</span><span class="n">MagSymmOp</span><span class="o">.</span><span class="n">from_xyzt_string</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">xyzt</span><span class="p">]</span>

                <span class="n">all_ops</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">magsymmops</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">centering_op</span> <span class="ow">in</span> <span class="n">centering_symops</span><span class="p">:</span>
                        <span class="n">new_translation</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">i</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">translation_vector</span> <span class="o">+</span> <span class="n">centering_op</span><span class="o">.</span><span class="n">translation_vector</span>
                        <span class="p">]</span>
                        <span class="n">new_time_reversal</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">time_reversal</span> <span class="o">*</span> <span class="n">centering_op</span><span class="o">.</span><span class="n">time_reversal</span>
                        <span class="n">all_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">MagSymmOp</span><span class="o">.</span><span class="n">from_rotation_and_translation_and_time_reversal</span><span class="p">(</span>
                                <span class="n">rotation_matrix</span><span class="o">=</span><span class="n">op</span><span class="o">.</span><span class="n">rotation_matrix</span><span class="p">,</span>
                                <span class="n">translation_vec</span><span class="o">=</span><span class="n">new_translation</span><span class="p">,</span>
                                <span class="n">time_reversal</span><span class="o">=</span><span class="n">new_time_reversal</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                <span class="n">magsymmops</span> <span class="o">=</span> <span class="n">all_ops</span>

        <span class="c1"># else check to see if it specifies a magnetic space group</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_space_group_magn.name_BNS&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_space_group_magn.number_BNS&quot;</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_space_group_magn.name_BNS&quot;</span><span class="p">):</span>
                <span class="c1"># get BNS label for MagneticSpaceGroup()</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_space_group_magn.name_BNS&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># get BNS number for MagneticSpaceGroup()</span>
                <span class="c1"># by converting string to list of ints</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_space_group_magn.number_BNS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">))))</span>

            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_space_group_magn.transform_BNS_Pp_abc&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_space_group_magn.transform_BNS_Pp_abc&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;a,b,c;0,0,0&quot;</span><span class="p">:</span>

                    <span class="n">jf</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_space_group_magn.transform_BNS_Pp_abc&quot;</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">MagneticSpaceGroup</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">jf</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_space_group_magn.transform_BNS_Pp&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Incomplete specification to implement.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">MagneticSpaceGroup</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

            <span class="n">magsymmops</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">symmetry_ops</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">magsymmops</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No magnetic symmetry detected, using primitive symmetry.&quot;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">magsymmops</span> <span class="o">=</span> <span class="p">[</span><span class="n">MagSymmOp</span><span class="o">.</span><span class="n">from_xyzt_string</span><span class="p">(</span><span class="s2">&quot;x, y, z, 1&quot;</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">magsymmops</span>
</pre></div>

        </details>

            <div class="docstring"><p>Equivalent to get_symops except for magnetic symmetry groups.
Separate function since additional operation for time reversal symmetry
(which changes magnetic moments on sites) needs to be returned.</p>
</div>


                            </div>
                            <div id="CifParser.parse_oxi_states" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CifParser.parse_oxi_states">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>

            <span class="def">def</span>
            <span class="name">parse_oxi_states</span><span class="signature">(data)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parse_oxi_states</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse oxidation states from data dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">oxi_states</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_type_symbol&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span> <span class="n">str2float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_type_oxidation_number&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_type_symbol&quot;</span><span class="p">]))</span>
            <span class="p">}</span>
            <span class="c1"># attempt to strip oxidation state from _atom_type_symbol</span>
            <span class="c1"># in case the label does not contain an oxidation state</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_type_symbol&quot;</span><span class="p">]):</span>
                <span class="n">oxi_states</span><span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d?[\+,\-]?$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)]</span> <span class="o">=</span> <span class="n">str2float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_type_oxidation_number&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
            <span class="n">oxi_states</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">oxi_states</span>
</pre></div>

        </details>

            <div class="docstring"><p>Parse oxidation states from data dictionary</p>
</div>


                            </div>
                            <div id="CifParser.parse_magmoms" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CifParser.parse_magmoms">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>

            <span class="def">def</span>
            <span class="name">parse_magmoms</span><span class="signature">(data, lattice=None)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parse_magmoms</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">lattice</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse atomic magnetic moments from data dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">lattice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Magmoms given in terms of crystal axes in magCIF spec.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">magmoms</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_moment_label&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">str2float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_moment_crystalaxis_x&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]),</span>
                        <span class="n">str2float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_moment_crystalaxis_y&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]),</span>
                        <span class="n">str2float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_moment_crystalaxis_z&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]),</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;_atom_site_moment_label&quot;</span><span class="p">]))</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">magmoms</span>
</pre></div>

        </details>

            <div class="docstring"><p>Parse atomic magnetic moments from data dictionary</p>
</div>


                            </div>
                            <div id="CifParser.get_structures" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CifParser.get_structures">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_structures</span><span class="signature">(self, primitive=True, symmetrized=False)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_structures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">primitive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">symmetrized</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return list of structures in CIF file. primitive boolean sets whether a</span>
<span class="sd">        conventional cell structure or primitive cell structure is returned.</span>

<span class="sd">        Args:</span>
<span class="sd">            primitive (bool): Set to False to return conventional unit cells.</span>
<span class="sd">                Defaults to True. With magnetic CIF files, will return primitive</span>
<span class="sd">                magnetic cell which may be larger than nuclear primitive cell.</span>
<span class="sd">            symmetrized (bool): If True, return a SymmetrizedStructure which will</span>
<span class="sd">                include the equivalent indices and symmetry operations used to</span>
<span class="sd">                create the Structure as provided by the CIF (if explicit symmetry</span>
<span class="sd">                operations are included in the CIF) or generated from information</span>
<span class="sd">                in the CIF (if only space group labels are provided). Note that</span>
<span class="sd">                currently Wyckoff labels and space group labels or numbers are</span>
<span class="sd">                not included in the generated SymmetrizedStructure, these will be</span>
<span class="sd">                notated as &quot;Not Parsed&quot; or -1 respectively.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of Structures.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">primitive</span> <span class="ow">and</span> <span class="n">symmetrized</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Using both &#39;primitive&#39; and &#39;symmetrized&#39; arguments is not currently supported &quot;</span>
                <span class="s2">&quot;since unexpected behavior might result.&quot;</span>
            <span class="p">)</span>

        <span class="n">structures</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cif</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_structure</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">primitive</span><span class="p">,</span> <span class="n">symmetrized</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                    <span class="n">structures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="c1"># Warn the user (Errors should never pass silently)</span>
                <span class="c1"># A user reported a problem with cif files produced by Avogadro</span>
                <span class="c1"># in which the atomic coordinates are in Cartesian coords.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No structure parsed for </span><span class="si">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2"> structure in CIF. Section of CIF file below.&quot;</span><span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error is </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Issues encountered while parsing CIF: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">structures</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid cif file with no structures!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">structures</span>
</pre></div>

        </details>

            <div class="docstring"><p>Return list of structures in CIF file. primitive boolean sets whether a
conventional cell structure or primitive cell structure is returned.</p>

<p>Args:
    primitive (bool): Set to False to return conventional unit cells.
        Defaults to True. With magnetic CIF files, will return primitive
        magnetic cell which may be larger than nuclear primitive cell.
    symmetrized (bool): If True, return a SymmetrizedStructure which will
        include the equivalent indices and symmetry operations used to
        create the Structure as provided by the CIF (if explicit symmetry
        operations are included in the CIF) or generated from information
        in the CIF (if only space group labels are provided). Note that
        currently Wyckoff labels and space group labels or numbers are
        not included in the generated SymmetrizedStructure, these will be
        notated as "Not Parsed" or -1 respectively.</p>

<p>Returns:
    List of Structures.</p>
</div>


                            </div>
                            <div id="CifParser.get_bibtex_string" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CifParser.get_bibtex_string">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_bibtex_string</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_bibtex_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get BibTeX reference from CIF file.</span>
<span class="sd">        :param data:</span>
<span class="sd">        :return: BibTeX string</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">pybtex.database</span> <span class="kn">import</span> <span class="n">BibliographyData</span><span class="p">,</span> <span class="n">Entry</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Bibliographic data extraction requires pybtex.&quot;</span><span class="p">)</span>

        <span class="n">bibtex_keys</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;author&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;_publ_author_name&quot;</span><span class="p">,</span> <span class="s2">&quot;_citation_author_name&quot;</span><span class="p">),</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;_publ_section_title&quot;</span><span class="p">,</span> <span class="s2">&quot;_citation_title&quot;</span><span class="p">),</span>
            <span class="s2">&quot;journal&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="s2">&quot;_journal_name_full&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_journal_name_abbrev&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_citation_journal_full&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_citation_journal_abbrev&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;_journal_volume&quot;</span><span class="p">,</span> <span class="s2">&quot;_citation_journal_volume&quot;</span><span class="p">),</span>
            <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;_journal_year&quot;</span><span class="p">,</span> <span class="s2">&quot;_citation_year&quot;</span><span class="p">),</span>
            <span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;_journal_number&quot;</span><span class="p">,</span> <span class="s2">&quot;_citation_number&quot;</span><span class="p">),</span>
            <span class="s2">&quot;page_first&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;_journal_page_first&quot;</span><span class="p">,</span> <span class="s2">&quot;_citation_page_first&quot;</span><span class="p">),</span>
            <span class="s2">&quot;page_last&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;_journal_page_last&quot;</span><span class="p">,</span> <span class="s2">&quot;_citation_page_last&quot;</span><span class="p">),</span>
            <span class="s2">&quot;doi&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;_journal_DOI&quot;</span><span class="p">,</span> <span class="s2">&quot;_citation_DOI&quot;</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="n">entries</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># TODO: parse &#39;_publ_section_references&#39; when it exists?</span>
        <span class="c1"># TODO: CIF specification supports multiple citations.</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cif</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>

            <span class="c1"># convert to lower-case keys, some cif files inconsistent</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

            <span class="n">bibtex_entry</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">tags</span> <span class="ow">in</span> <span class="n">bibtex_keys</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">tag</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">bibtex_entry</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">tag</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">bibtex_entry</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>

            <span class="c1"># convert to bibtex author format (&#39;and&#39; delimited)</span>
            <span class="k">if</span> <span class="s2">&quot;author&quot;</span> <span class="ow">in</span> <span class="n">bibtex_entry</span><span class="p">:</span>
                <span class="c1"># separate out semicolon authors</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bibtex_entry</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s2">&quot;;&quot;</span> <span class="ow">in</span> <span class="n">bibtex_entry</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">]:</span>
                        <span class="n">bibtex_entry</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bibtex_entry</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bibtex_entry</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">bibtex_entry</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; and &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bibtex_entry</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">])</span>

            <span class="c1"># convert to bibtex page range format, use empty string if not specified</span>
            <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;page_first&quot;</span> <span class="ow">in</span> <span class="n">bibtex_entry</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;page_last&quot;</span> <span class="ow">in</span> <span class="n">bibtex_entry</span><span class="p">):</span>
                <span class="n">bibtex_entry</span><span class="p">[</span><span class="s2">&quot;pages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">--</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">bibtex_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;page_first&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                    <span class="n">bibtex_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;page_last&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">bibtex_entry</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;page_first&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># and remove page_first, page_list if present</span>
                <span class="n">bibtex_entry</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;page_last&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="c1"># cite keys are given as cif-reference-idx in order they are found</span>
            <span class="n">entries</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;cifref</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Entry</span><span class="p">(</span><span class="s2">&quot;article&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">bibtex_entry</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>

        <span class="k">return</span> <span class="n">BibliographyData</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">bib_format</span><span class="o">=</span><span class="s2">&quot;bibtex&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Get BibTeX reference from CIF file.
:param data:
:return: BibTeX string</p>
</div>


                            </div>
                            <div id="CifParser.as_dict" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CifParser.as_dict">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">as_dict</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: MSONable dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cif</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k2</span><span class="p">,</span> <span class="n">v2</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">k2</span><span class="p">]</span> <span class="o">=</span> <span class="n">v2</span>
        <span class="k">return</span> <span class="n">d</span>
</pre></div>

        </details>

            <div class="docstring"><p>:return: MSONable dict</p>
</div>


                            </div>
                            <div id="CifParser.has_errors" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#CifParser.has_errors">#&nbsp;&nbsp</a>

        <span class="name">has_errors</span>
    </div>

    
            <div class="docstring"><p>:return: Whether there are errors/warnings detected in CIF parsing.</p>
</div>


                            </div>
                </section>
                <section id="CifWriter">
                                <div class="attr class">
        <a class="headerlink" href="#CifWriter">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">CifWriter</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">CifWriter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A wrapper around CifFile to write CIF files from pymatgen structures.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">struct</span><span class="p">,</span>
        <span class="n">symprec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">write_magmoms</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">significant_figures</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">angle_tolerance</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">refine_struct</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            struct (Structure): structure to write</span>
<span class="sd">            symprec (float): If not none, finds the symmetry of the structure</span>
<span class="sd">                and writes the cif with symmetry information. Passes symprec</span>
<span class="sd">                to the SpacegroupAnalyzer. See also refine_struct.</span>
<span class="sd">            write_magmoms (bool): If True, will write magCIF file. Incompatible</span>
<span class="sd">                with symprec</span>
<span class="sd">            significant_figures (int): Specifies precision for formatting of floats.</span>
<span class="sd">                Defaults to 8.</span>
<span class="sd">            angle_tolerance (float): Angle tolerance for symmetry finding. Passes</span>
<span class="sd">                angle_tolerance to the SpacegroupAnalyzer. Used only if symprec</span>
<span class="sd">                is not None.</span>
<span class="sd">            refine_struct: Used only if symprec is not None. If True, get_refined_structure</span>
<span class="sd">                is invoked to convert input structure from primitive to conventional.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">write_magmoms</span> <span class="ow">and</span> <span class="n">symprec</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Magnetic symmetry cannot currently be detected by pymatgen,disabling symmetry detection.&quot;</span><span class="p">)</span>
            <span class="n">symprec</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">format_str</span> <span class="o">=</span> <span class="s2">&quot;{:.</span><span class="si">%d</span><span class="s2">f}&quot;</span> <span class="o">%</span> <span class="n">significant_figures</span>

        <span class="n">block</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">loops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">spacegroup</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;P 1&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">symprec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sf</span> <span class="o">=</span> <span class="n">SpacegroupAnalyzer</span><span class="p">(</span><span class="n">struct</span><span class="p">,</span> <span class="n">symprec</span><span class="p">,</span> <span class="n">angle_tolerance</span><span class="o">=</span><span class="n">angle_tolerance</span><span class="p">)</span>
            <span class="n">spacegroup</span> <span class="o">=</span> <span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">get_space_group_symbol</span><span class="p">(),</span> <span class="n">sf</span><span class="o">.</span><span class="n">get_space_group_number</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">refine_struct</span><span class="p">:</span>
                <span class="c1"># Needs the refined structure when using symprec. This converts</span>
                <span class="c1"># primitive to conventional structures, the standard for CIF.</span>
                <span class="n">struct</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">get_refined_structure</span><span class="p">()</span>

        <span class="n">latt</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">lattice</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">composition</span>
        <span class="n">no_oxi_comp</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">element_composition</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_symmetry_space_group_name_H-M&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spacegroup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">cell_attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">]:</span>
            <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_cell_length_&quot;</span> <span class="o">+</span> <span class="n">cell_attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">latt</span><span class="p">,</span> <span class="n">cell_attr</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">cell_attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">,</span> <span class="s2">&quot;gamma&quot;</span><span class="p">]:</span>
            <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_cell_angle_&quot;</span> <span class="o">+</span> <span class="n">cell_attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">latt</span><span class="p">,</span> <span class="n">cell_attr</span><span class="p">))</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_symmetry_Int_Tables_number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spacegroup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_chemical_formula_structural&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">no_oxi_comp</span><span class="o">.</span><span class="n">reduced_formula</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_chemical_formula_sum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">no_oxi_comp</span><span class="o">.</span><span class="n">formula</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_cell_volume&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">latt</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span>

        <span class="n">reduced_comp</span><span class="p">,</span> <span class="n">fu</span> <span class="o">=</span> <span class="n">no_oxi_comp</span><span class="o">.</span><span class="n">get_reduced_composition_and_factor</span><span class="p">()</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_cell_formula_units_Z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">fu</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">symprec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_symmetry_equiv_pos_site_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="p">]</span>
            <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_symmetry_equiv_pos_as_xyz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x, y, z&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sf</span> <span class="o">=</span> <span class="n">SpacegroupAnalyzer</span><span class="p">(</span><span class="n">struct</span><span class="p">,</span> <span class="n">symprec</span><span class="p">)</span>

            <span class="n">symmops</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sf</span><span class="o">.</span><span class="n">get_symmetry_operations</span><span class="p">():</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">translation_vector</span>
                <span class="n">symmops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SymmOp</span><span class="o">.</span><span class="n">from_rotation_and_translation</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">rotation_matrix</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>

            <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">as_xyz_string</span><span class="p">()</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">symmops</span><span class="p">]</span>
            <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_symmetry_equiv_pos_site_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_symmetry_equiv_pos_as_xyz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ops</span>

        <span class="n">loops</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;_symmetry_equiv_pos_site_id&quot;</span><span class="p">,</span> <span class="s2">&quot;_symmetry_equiv_pos_as_xyz&quot;</span><span class="p">])</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">symbol_to_oxinum</span> <span class="o">=</span> <span class="p">{</span><span class="n">el</span><span class="o">.</span><span class="fm">__str__</span><span class="p">():</span> <span class="nb">float</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">oxi_state</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">elements</span><span class="p">)}</span>
            <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_atom_type_symbol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">symbol_to_oxinum</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_atom_type_oxidation_number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">symbol_to_oxinum</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="n">loops</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;_atom_type_symbol&quot;</span><span class="p">,</span> <span class="s2">&quot;_atom_type_oxidation_number&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
            <span class="n">symbol_to_oxinum</span> <span class="o">=</span> <span class="p">{</span><span class="n">el</span><span class="o">.</span><span class="n">symbol</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">elements</span><span class="p">)}</span>

        <span class="n">atom_site_type_symbol</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atom_site_symmetry_multiplicity</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atom_site_fract_x</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atom_site_fract_y</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atom_site_fract_z</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atom_site_label</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atom_site_occupancy</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atom_site_moment_label</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atom_site_moment_crystalaxis_x</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atom_site_moment_crystalaxis_y</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atom_site_moment_crystalaxis_z</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">symprec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">struct</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">occu</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="n">atom_site_type_symbol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="fm">__str__</span><span class="p">())</span>
                    <span class="n">atom_site_symmetry_multiplicity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
                    <span class="n">atom_site_fract_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">a</span><span class="p">))</span>
                    <span class="n">atom_site_fract_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">b</span><span class="p">))</span>
                    <span class="n">atom_site_fract_z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">c</span><span class="p">))</span>
                    <span class="n">atom_site_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sp</span><span class="o">.</span><span class="n">symbol</span><span class="si">}{</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">atom_site_occupancy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">occu</span><span class="o">.</span><span class="fm">__str__</span><span class="p">())</span>

                    <span class="n">magmom</span> <span class="o">=</span> <span class="n">Magmom</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;magmom&quot;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="s2">&quot;spin&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">write_magmoms</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">magmom</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">moment</span> <span class="o">=</span> <span class="n">Magmom</span><span class="o">.</span><span class="n">get_moment_relative_to_crystal_axes</span><span class="p">(</span><span class="n">magmom</span><span class="p">,</span> <span class="n">latt</span><span class="p">)</span>
                        <span class="n">atom_site_moment_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sp</span><span class="o">.</span><span class="n">symbol</span><span class="si">}{</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">atom_site_moment_crystalaxis_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">moment</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                        <span class="n">atom_site_moment_crystalaxis_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">moment</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="n">atom_site_moment_crystalaxis_z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">moment</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># The following just presents a deterministic ordering.</span>
            <span class="n">unique_sites</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span>
                    <span class="nb">sorted</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">))[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">sites</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">sites</span> <span class="ow">in</span> <span class="n">sf</span><span class="o">.</span><span class="n">get_symmetrized_structure</span><span class="p">()</span><span class="o">.</span><span class="n">equivalent_sites</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">site</span><span class="p">,</span> <span class="n">mult</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="n">unique_sites</span><span class="p">,</span>
                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="p">(</span>
                    <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">average_electroneg</span><span class="p">,</span>
                    <span class="o">-</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">a</span><span class="p">,</span>
                    <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">b</span><span class="p">,</span>
                    <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">c</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">):</span>
                <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">occu</span> <span class="ow">in</span> <span class="n">site</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">atom_site_type_symbol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="fm">__str__</span><span class="p">())</span>
                    <span class="n">atom_site_symmetry_multiplicity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mult</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">atom_site_fract_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">a</span><span class="p">))</span>
                    <span class="n">atom_site_fract_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">b</span><span class="p">))</span>
                    <span class="n">atom_site_fract_z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">c</span><span class="p">))</span>
                    <span class="n">atom_site_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sp</span><span class="o">.</span><span class="n">symbol</span><span class="si">}{</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">atom_site_occupancy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">occu</span><span class="o">.</span><span class="fm">__str__</span><span class="p">())</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_atom_site_type_symbol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom_site_type_symbol</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_atom_site_label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom_site_label</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_atom_site_symmetry_multiplicity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom_site_symmetry_multiplicity</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_atom_site_fract_x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom_site_fract_x</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_atom_site_fract_y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom_site_fract_y</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_atom_site_fract_z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom_site_fract_z</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_atom_site_occupancy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom_site_occupancy</span>
        <span class="n">loops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;_atom_site_type_symbol&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_atom_site_label&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_atom_site_symmetry_multiplicity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_atom_site_fract_x&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_atom_site_fract_y&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_atom_site_fract_z&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_atom_site_occupancy&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">write_magmoms</span><span class="p">:</span>
            <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_atom_site_moment_label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom_site_moment_label</span>
            <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_atom_site_moment_crystalaxis_x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom_site_moment_crystalaxis_x</span>
            <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_atom_site_moment_crystalaxis_y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom_site_moment_crystalaxis_y</span>
            <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_atom_site_moment_crystalaxis_z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom_site_moment_crystalaxis_z</span>
            <span class="n">loops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;_atom_site_moment_label&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;_atom_site_moment_crystalaxis_x&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;_atom_site_moment_crystalaxis_y&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;_atom_site_moment_crystalaxis_z&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">d</span><span class="p">[</span><span class="n">comp</span><span class="o">.</span><span class="n">reduced_formula</span><span class="p">]</span> <span class="o">=</span> <span class="n">CifBlock</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">loops</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">reduced_formula</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cf</span> <span class="o">=</span> <span class="n">CifFile</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ciffile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns: CifFile associated with the CifWriter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cf</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the cif as a string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cf</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">write_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the cif file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">zopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">())</span>
</pre></div>

        </details>

            <div class="docstring"><p>A wrapper around CifFile to write CIF files from pymatgen structures.</p>
</div>


                            <div id="CifWriter.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CifWriter.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">CifWriter</span><span class="signature">(
    struct,
    symprec=None,
    write_magmoms=False,
    significant_figures=8,
    angle_tolerance=5.0,
    refine_struct=True
)</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">struct</span><span class="p">,</span>
        <span class="n">symprec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">write_magmoms</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">significant_figures</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">angle_tolerance</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">refine_struct</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            struct (Structure): structure to write</span>
<span class="sd">            symprec (float): If not none, finds the symmetry of the structure</span>
<span class="sd">                and writes the cif with symmetry information. Passes symprec</span>
<span class="sd">                to the SpacegroupAnalyzer. See also refine_struct.</span>
<span class="sd">            write_magmoms (bool): If True, will write magCIF file. Incompatible</span>
<span class="sd">                with symprec</span>
<span class="sd">            significant_figures (int): Specifies precision for formatting of floats.</span>
<span class="sd">                Defaults to 8.</span>
<span class="sd">            angle_tolerance (float): Angle tolerance for symmetry finding. Passes</span>
<span class="sd">                angle_tolerance to the SpacegroupAnalyzer. Used only if symprec</span>
<span class="sd">                is not None.</span>
<span class="sd">            refine_struct: Used only if symprec is not None. If True, get_refined_structure</span>
<span class="sd">                is invoked to convert input structure from primitive to conventional.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">write_magmoms</span> <span class="ow">and</span> <span class="n">symprec</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Magnetic symmetry cannot currently be detected by pymatgen,disabling symmetry detection.&quot;</span><span class="p">)</span>
            <span class="n">symprec</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">format_str</span> <span class="o">=</span> <span class="s2">&quot;{:.</span><span class="si">%d</span><span class="s2">f}&quot;</span> <span class="o">%</span> <span class="n">significant_figures</span>

        <span class="n">block</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">loops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">spacegroup</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;P 1&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">symprec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sf</span> <span class="o">=</span> <span class="n">SpacegroupAnalyzer</span><span class="p">(</span><span class="n">struct</span><span class="p">,</span> <span class="n">symprec</span><span class="p">,</span> <span class="n">angle_tolerance</span><span class="o">=</span><span class="n">angle_tolerance</span><span class="p">)</span>
            <span class="n">spacegroup</span> <span class="o">=</span> <span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">get_space_group_symbol</span><span class="p">(),</span> <span class="n">sf</span><span class="o">.</span><span class="n">get_space_group_number</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">refine_struct</span><span class="p">:</span>
                <span class="c1"># Needs the refined structure when using symprec. This converts</span>
                <span class="c1"># primitive to conventional structures, the standard for CIF.</span>
                <span class="n">struct</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">get_refined_structure</span><span class="p">()</span>

        <span class="n">latt</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">lattice</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">composition</span>
        <span class="n">no_oxi_comp</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">element_composition</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_symmetry_space_group_name_H-M&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spacegroup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">cell_attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">]:</span>
            <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_cell_length_&quot;</span> <span class="o">+</span> <span class="n">cell_attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">latt</span><span class="p">,</span> <span class="n">cell_attr</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">cell_attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">,</span> <span class="s2">&quot;gamma&quot;</span><span class="p">]:</span>
            <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_cell_angle_&quot;</span> <span class="o">+</span> <span class="n">cell_attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">latt</span><span class="p">,</span> <span class="n">cell_attr</span><span class="p">))</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_symmetry_Int_Tables_number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spacegroup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_chemical_formula_structural&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">no_oxi_comp</span><span class="o">.</span><span class="n">reduced_formula</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_chemical_formula_sum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">no_oxi_comp</span><span class="o">.</span><span class="n">formula</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_cell_volume&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">latt</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span>

        <span class="n">reduced_comp</span><span class="p">,</span> <span class="n">fu</span> <span class="o">=</span> <span class="n">no_oxi_comp</span><span class="o">.</span><span class="n">get_reduced_composition_and_factor</span><span class="p">()</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_cell_formula_units_Z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">fu</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">symprec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_symmetry_equiv_pos_site_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="p">]</span>
            <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_symmetry_equiv_pos_as_xyz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x, y, z&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sf</span> <span class="o">=</span> <span class="n">SpacegroupAnalyzer</span><span class="p">(</span><span class="n">struct</span><span class="p">,</span> <span class="n">symprec</span><span class="p">)</span>

            <span class="n">symmops</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sf</span><span class="o">.</span><span class="n">get_symmetry_operations</span><span class="p">():</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">translation_vector</span>
                <span class="n">symmops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SymmOp</span><span class="o">.</span><span class="n">from_rotation_and_translation</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">rotation_matrix</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>

            <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">as_xyz_string</span><span class="p">()</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">symmops</span><span class="p">]</span>
            <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_symmetry_equiv_pos_site_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_symmetry_equiv_pos_as_xyz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ops</span>

        <span class="n">loops</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;_symmetry_equiv_pos_site_id&quot;</span><span class="p">,</span> <span class="s2">&quot;_symmetry_equiv_pos_as_xyz&quot;</span><span class="p">])</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">symbol_to_oxinum</span> <span class="o">=</span> <span class="p">{</span><span class="n">el</span><span class="o">.</span><span class="fm">__str__</span><span class="p">():</span> <span class="nb">float</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">oxi_state</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">elements</span><span class="p">)}</span>
            <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_atom_type_symbol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">symbol_to_oxinum</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_atom_type_oxidation_number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">symbol_to_oxinum</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="n">loops</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;_atom_type_symbol&quot;</span><span class="p">,</span> <span class="s2">&quot;_atom_type_oxidation_number&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
            <span class="n">symbol_to_oxinum</span> <span class="o">=</span> <span class="p">{</span><span class="n">el</span><span class="o">.</span><span class="n">symbol</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">elements</span><span class="p">)}</span>

        <span class="n">atom_site_type_symbol</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atom_site_symmetry_multiplicity</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atom_site_fract_x</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atom_site_fract_y</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atom_site_fract_z</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atom_site_label</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atom_site_occupancy</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atom_site_moment_label</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atom_site_moment_crystalaxis_x</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atom_site_moment_crystalaxis_y</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atom_site_moment_crystalaxis_z</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">symprec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">struct</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">occu</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="n">atom_site_type_symbol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="fm">__str__</span><span class="p">())</span>
                    <span class="n">atom_site_symmetry_multiplicity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
                    <span class="n">atom_site_fract_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">a</span><span class="p">))</span>
                    <span class="n">atom_site_fract_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">b</span><span class="p">))</span>
                    <span class="n">atom_site_fract_z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">c</span><span class="p">))</span>
                    <span class="n">atom_site_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sp</span><span class="o">.</span><span class="n">symbol</span><span class="si">}{</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">atom_site_occupancy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">occu</span><span class="o">.</span><span class="fm">__str__</span><span class="p">())</span>

                    <span class="n">magmom</span> <span class="o">=</span> <span class="n">Magmom</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;magmom&quot;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="s2">&quot;spin&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">write_magmoms</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">magmom</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">moment</span> <span class="o">=</span> <span class="n">Magmom</span><span class="o">.</span><span class="n">get_moment_relative_to_crystal_axes</span><span class="p">(</span><span class="n">magmom</span><span class="p">,</span> <span class="n">latt</span><span class="p">)</span>
                        <span class="n">atom_site_moment_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sp</span><span class="o">.</span><span class="n">symbol</span><span class="si">}{</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">atom_site_moment_crystalaxis_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">moment</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                        <span class="n">atom_site_moment_crystalaxis_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">moment</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="n">atom_site_moment_crystalaxis_z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">moment</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># The following just presents a deterministic ordering.</span>
            <span class="n">unique_sites</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span>
                    <span class="nb">sorted</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">))[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">sites</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">sites</span> <span class="ow">in</span> <span class="n">sf</span><span class="o">.</span><span class="n">get_symmetrized_structure</span><span class="p">()</span><span class="o">.</span><span class="n">equivalent_sites</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">site</span><span class="p">,</span> <span class="n">mult</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="n">unique_sites</span><span class="p">,</span>
                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="p">(</span>
                    <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">average_electroneg</span><span class="p">,</span>
                    <span class="o">-</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">a</span><span class="p">,</span>
                    <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">b</span><span class="p">,</span>
                    <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">c</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">):</span>
                <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">occu</span> <span class="ow">in</span> <span class="n">site</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">atom_site_type_symbol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="fm">__str__</span><span class="p">())</span>
                    <span class="n">atom_site_symmetry_multiplicity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mult</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">atom_site_fract_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">a</span><span class="p">))</span>
                    <span class="n">atom_site_fract_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">b</span><span class="p">))</span>
                    <span class="n">atom_site_fract_z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">c</span><span class="p">))</span>
                    <span class="n">atom_site_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sp</span><span class="o">.</span><span class="n">symbol</span><span class="si">}{</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">atom_site_occupancy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">occu</span><span class="o">.</span><span class="fm">__str__</span><span class="p">())</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_atom_site_type_symbol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom_site_type_symbol</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_atom_site_label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom_site_label</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_atom_site_symmetry_multiplicity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom_site_symmetry_multiplicity</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_atom_site_fract_x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom_site_fract_x</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_atom_site_fract_y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom_site_fract_y</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_atom_site_fract_z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom_site_fract_z</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_atom_site_occupancy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom_site_occupancy</span>
        <span class="n">loops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;_atom_site_type_symbol&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_atom_site_label&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_atom_site_symmetry_multiplicity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_atom_site_fract_x&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_atom_site_fract_y&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_atom_site_fract_z&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_atom_site_occupancy&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">write_magmoms</span><span class="p">:</span>
            <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_atom_site_moment_label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom_site_moment_label</span>
            <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_atom_site_moment_crystalaxis_x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom_site_moment_crystalaxis_x</span>
            <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_atom_site_moment_crystalaxis_y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom_site_moment_crystalaxis_y</span>
            <span class="n">block</span><span class="p">[</span><span class="s2">&quot;_atom_site_moment_crystalaxis_z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom_site_moment_crystalaxis_z</span>
            <span class="n">loops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;_atom_site_moment_label&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;_atom_site_moment_crystalaxis_x&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;_atom_site_moment_crystalaxis_y&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;_atom_site_moment_crystalaxis_z&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">d</span><span class="p">[</span><span class="n">comp</span><span class="o">.</span><span class="n">reduced_formula</span><span class="p">]</span> <span class="o">=</span> <span class="n">CifBlock</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">loops</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">reduced_formula</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cf</span> <span class="o">=</span> <span class="n">CifFile</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Args:
    struct (Structure): structure to write
    symprec (float): If not none, finds the symmetry of the structure
        and writes the cif with symmetry information. Passes symprec
        to the SpacegroupAnalyzer. See also refine_struct.
    write_magmoms (bool): If True, will write magCIF file. Incompatible
        with symprec
    significant_figures (int): Specifies precision for formatting of floats.
        Defaults to 8.
    angle_tolerance (float): Angle tolerance for symmetry finding. Passes
        angle_tolerance to the SpacegroupAnalyzer. Used only if symprec
        is not None.
    refine_struct: Used only if symprec is not None. If True, get_refined_structure
        is invoked to convert input structure from primitive to conventional.</p>
</div>


                            </div>
                            <div id="CifWriter.ciffile" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#CifWriter.ciffile">#&nbsp;&nbsp</a>

        <span class="name">ciffile</span>
    </div>

    
            <div class="docstring"><p>Returns: CifFile associated with the CifWriter.</p>
</div>


                            </div>
                            <div id="CifWriter.write_file" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CifWriter.write_file">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">write_file</span><span class="signature">(self, filename)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">write_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the cif file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">zopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">())</span>
</pre></div>

        </details>

            <div class="docstring"><p>Write the cif file.</p>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.type) {
                    case "function":
                        heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span><span class="signature">${doc.signature}:</span>`;
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value">${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.type}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>